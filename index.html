<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDENTITY TERMINAL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #e0e0e0;
            --accent-color: #ff003c;
            /* Cyberpunk Red */
            --dim-color: #4a4a4a;
            --grid-color: #1a1a1a;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* CRT Scanline effect */
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* --- RETINA SCAN LOADER --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
            animation: scan 1.5s infinite linear;
            position: absolute;
            top: 0;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .loader-text {
            color: var(--accent-color);
            font-size: 14px;
            letter-spacing: 2px;
            margin-top: 20px;
            text-shadow: 0 0 5px var(--accent-color);
        }

        /* --- UI ELEMENTS --- */
        .container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: none;
            /* Hidden until loaded */
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        h1 {
            color: var(--accent-color);
            text-align: center;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 4px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        /* Glitch Effect */
        .glitch {
            position: relative;
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
        }

        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #00ffff;
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #ff00ff;
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% {
                clip: rect(10px, 9999px, 30px, 0);
            }

            20% {
                clip: rect(80px, 9999px, 100px, 0);
            }

            40% {
                clip: rect(10px, 9999px, 50px, 0);
            }

            60% {
                clip: rect(60px, 9999px, 80px, 0);
            }

            80% {
                clip: rect(30px, 9999px, 60px, 0);
            }

            100% {
                clip: rect(90px, 9999px, 120px, 0);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                clip: rect(50px, 9999px, 70px, 0);
            }

            20% {
                clip: rect(10px, 9999px, 30px, 0);
            }

            40% {
                clip: rect(90px, 9999px, 110px, 0);
            }

            60% {
                clip: rect(20px, 9999px, 40px, 0);
            }

            80% {
                clip: rect(70px, 9999px, 90px, 0);
            }

            100% {
                clip: rect(10px, 9999px, 50px, 0);
            }
        }

        /* TABS */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            border: 1px solid var(--dim-color);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--dim-color);
            transition: 0.3s;
            font-weight: bold;
            font-size: 14px;
        }

        .tab.active {
            color: var(--bg-color);
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
        }

        /* CARD STYLE */
        .card {
            border: 1px solid var(--dim-color);
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(20, 20, 20, 0.8);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid var(--accent-color);
            border-left: 2px solid var(--accent-color);
        }

        .card::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid var(--accent-color);
            border-right: 2px solid var(--accent-color);
        }

        /* INPUTS */
        textarea {
            width: 100%;
            background: #111;
            border: 1px solid var(--dim-color);
            color: var(--accent-color);
            padding: 10px;
            font-family: inherit;
            margin-top: 10px;
            resize: vertical;
            min-height: 80px;
            outline: none;
            box-sizing: border-box;
        }

        textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(255, 0, 60, 0.5);
        }

        label {
            color: #fff;
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        /* BUTTONS */
        .cyber-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .cyber-btn:hover {
            background: var(--accent-color);
            color: #000;
            box-shadow: 0 0 20px var(--accent-color);
        }

        .cyber-btn:active {
            transform: scale(0.98);
        }

        /* CHART */
        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>

<body>

    <!-- RETINA SCAN LOADER -->
    <div id="loader">
        <div class="scan-line"></div>
        <div style="font-size:40px; color:var(--accent-color);">üëÅ</div>
        <div class="loader-text" id="loader-msg">INITIALIZING...</div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="container" id="app">
        <h1 class="glitch" data-text="IDENTITY_TERMINAL">IDENTITY_TERMINAL</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('profile')">–î–û–°–¨–ï</div>
            <div class="tab" onclick="switchTab('stats')">–≠–ù–ï–†–ì–ò–Ø</div>
        </div>

        <!-- PROFILE SECTION -->
        <div id="profile-section">

            <!-- VIEW MODE -->
            <div id="profile-view" style="display:none;">
                <div class="card">
                    <label>STATUS</label>
                    <div style="color:#0f0; margin-bottom:10px;">‚óè ACTIVE</div>

                    <label>–¶–ï–õ–¨</label>
                    <div id="view-goal"
                        style="color:#fff; margin-bottom:10px; border-bottom:1px dashed #333; padding-bottom:5px;">...
                    </div>

                    <label>–°–¢–†–ê–•</label>
                    <div id="view-fear"
                        style="color:#fff; margin-bottom:10px; border-bottom:1px dashed #333; padding-bottom:5px;">...
                    </div>

                    <label>–¶–ï–ù–ê</label>
                    <div id="view-price" style="color:#fff; margin-bottom:10px;">...</div>
                </div>
                <button class="cyber-btn" onclick="editProfile()">// REWRITE_DATA</button>
            </div>

            <!-- EDIT MODE -->
            <div id="profile-edit" style="display:none;">
                <div class="card">
                    <div class="step" id="step1">
                        <label>1. –ë–û–õ–¨ (–ß–¢–û –ú–ï–®–ê–ï–¢?)</label>
                        <textarea id="pain"></textarea>
                        <button class="cyber-btn" onclick="nextStep(1)">NEXT >></button>
                    </div>

                    <div class="step" id="step2" style="display:none">
                        <label>2. –°–¢–†–ê–• (–ß–ï–ì–û –ë–û–ò–®–¨–°–Ø?)</label>
                        <textarea id="fear"></textarea>
                        <button class="cyber-btn" onclick="nextStep(2)">NEXT >></button>
                    </div>

                    <div class="step" id="step3" style="display:none">
                        <label>3. –¶–ï–õ–¨ (–ß–ï–ì–û –•–û–ß–ï–®–¨?)</label>
                        <textarea id="goal"></textarea>
                        <button class="cyber-btn" onclick="nextStep(3)">NEXT >></button>
                    </div>

                    <div class="step" id="step4" style="display:none">
                        <label>4. –¶–ï–ù–ê (–ß–ï–ú –ü–û–ñ–ï–†–¢–í–£–ï–®–¨?)</label>
                        <textarea id="price"></textarea>
                        <button class="cyber-btn" onclick="saveData()">// UPLOAD_TO_CORE</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS SECTION -->
        <div id="stats-section" style="display:none;">
            <div class="card">
                <label>–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ (7 –î–ù–ï–ô)</label>
                <div class="chart-wrapper">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>
            <div style="text-align:center; font-size:10px; color:var(--dim-color); margin-top:10px;">
                SYNCED WITH NEURAL NETWORK
            </div>
        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- LOADER LOGIC ---
        window.onload = function () {
            const msgs = ["CONNECTING...", "RETINA SCAN...", "ACCESS GRANTED"];
            let i = 0;
            const interval = setInterval(() => {
                document.getElementById('loader-msg').innerText = msgs[i];
                i++;
                if (i >= msgs.length) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                            loadData(); // Load cloud data
                        }, 500);
                    }, 800);
                }
            }, 800);
        };

        // --- TABS LOGIC ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'profile') {
                document.getElementById('profile-section').style.display = 'block';
                document.getElementById('stats-section').style.display = 'none';
            } else {
                document.getElementById('profile-section').style.display = 'none';
                document.getElementById('stats-section').style.display = 'block';
                renderChart();
            }
            tg.HapticFeedback.selectionChanged();
        }

        // --- DATA LOGIC ---
        const data = { pain: "", fear: "", goal: "", price: "" };

        function loadData() {
            tg.CloudStorage.getKeys((err, keys) => {
                if (!err && keys.length > 0) {
                    tg.CloudStorage.getItems(keys, (err, items) => {
                        if (!err && items) {
                            if (items.pain) document.getElementById('pain').value = items.pain;
                            if (items.fear) document.getElementById('fear').value = items.fear;
                            if (items.goal) document.getElementById('goal').value = items.goal;
                            if (items.price) document.getElementById('price').value = items.price;

                            if (items.goal && items.fear && items.price) {
                                showViewMode(items);
                            } else {
                                showEditMode();
                            }
                        }
                    });
                } else {
                    showEditMode();
                }
            });
        }

        function showViewMode(items) {
            document.getElementById('view-goal').innerText = items.goal || "N/A";
            document.getElementById('view-fear').innerText = items.fear || "N/A";
            document.getElementById('view-price').innerText = items.price || "N/A";
            document.getElementById('profile-view').style.display = 'block';
            document.getElementById('profile-edit').style.display = 'none';
        }

        function showEditMode() {
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('profile-edit').style.display = 'block';
            document.getElementById('step1').style.display = 'block';
        }

        function editProfile() {
            showEditMode();
            tg.HapticFeedback.impactOccurred('medium');
        }

        function nextStep(current) {
            const fields = ['pain', 'fear', 'goal'];
            const val = document.getElementById(fields[current - 1]).value;

            if (!val) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            // Auto-save step
            tg.CloudStorage.setItem(fields[current - 1], val);

            document.getElementById('step' + current).style.display = 'none';
            document.getElementById('step' + (current + 1)).style.display = 'block';
            tg.HapticFeedback.impactOccurred('light');
        }

        function saveData() {
            const price = document.getElementById('price').value;
            if (!price) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            tg.CloudStorage.setItem('price', price, (err, saved) => {
                if (!err) {
                    tg.HapticFeedback.notificationOccurred('success');
                    // Reload data to show view
                    loadData();
                }
            });
        }

        // --- CHART LOGIC ---
        let chartInstance = null;

        function getStatsFromUrl() {
            try {
                const hash = window.location.hash;
                if (hash.includes('stats=')) {
                    // Handle potential double encoding or simple string
                    const param = hash.split('stats=')[1];
                    const jsonStr = decodeURIComponent(param);
                    const data = JSON.parse(jsonStr);
                    if (data.labels && data.labels.length > 0) {
                        return data;
                    }
                }
            } catch (e) {
                console.error("Error parsing stats:", e);
            }
            return null;
        }

        function renderChart() {
            const ctx = document.getElementById('energyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(255, 0, 60, 0.5)');
            gradient.addColorStop(1, 'rgba(255, 0, 60, 0)');

            // Get Real Data
            const stats = getStatsFromUrl();
            // Default to empty/zero if no stats found (New User)
            const labels = stats ? stats.labels : ['-', '-', '-', '-', '-', '-', '-'];
            const dataPoints = stats ? stats.values : [0, 0, 0, 0, 0, 0, 0];

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–≠–ù–ï–†–ì–ò–Ø',
                        data: dataPoints,
                        borderColor: '#ff003c',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#ff003c',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: '#333' },
                            ticks: { color: '#666' }
                        },
                        x: {
                            grid: { color: '#1a1a1a' },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>